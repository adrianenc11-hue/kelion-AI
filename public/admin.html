<!DOCTYPE html>
<html lang="ro">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelion Admin Panel</title>
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 50%, #0a1a2e 100%);
            color: #fff;
            min-height: 100vh;
        }

        /* Login Container */
        #login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .login-logo {
            width: 120px;
            height: auto;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 2rem;
            color: #d4af37;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .login-subtitle {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 30px;
        }

        .login-btn {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            border: none;
            padding: 15px 40px;
            color: #0a0a1a;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4);
        }

        /* Dashboard Container */
        #dashboard-container {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            height: 50px;
        }

        .header-title {
            font-size: 1.5rem;
            color: #d4af37;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-email {
            color: rgba(255, 255, 255, 0.7);
        }

        .logout-btn {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            padding: 10px 20px;
            color: #ff6464;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 100, 100, 0.3);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(212, 175, 55, 0.5);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #d4af37;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }

        /* System Status */
        .section-title {
            font-size: 1.5rem;
            color: #d4af37;
            margin-bottom: 20px;
            padding-left: 15px;
            border-left: 3px solid #d4af37;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-name {
            font-weight: bold;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-badge.online {
            background: rgba(0, 255, 100, 0.2);
            color: #00ff64;
        }

        .status-badge.offline {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
        }

        .status-badge.checking {
            background: rgba(255, 200, 0, 0.2);
            color: #ffc800;
        }

        .status-detail {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        /* Environment Variables */
        .env-table {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .env-table th,
        .env-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .env-table th {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }

        .env-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .env-status.configured {
            background: #00ff64;
            box-shadow: 0 0 10px rgba(0, 255, 100, 0.5);
        }

        .env-status.missing {
            background: #ff6464;
            box-shadow: 0 0 10px rgba(255, 100, 100, 0.5);
        }

        /* Quick Actions */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .action-btn {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            padding: 20px;
            color: #00ffff;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .action-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            border: none;
            color: #0a0a1a;
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* AI Credits Dashboard */
        .credits-grid {
            display: flex;
            flex-direction: row;
            gap: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 15px;
            scroll-behavior: smooth;
        }

        .credits-grid::-webkit-scrollbar {
            height: 8px;
        }

        .credits-grid::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .credits-grid::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.5);
            border-radius: 10px;
        }

        .credits-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.8);
        }

        .credit-card {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            min-width: 280px;
            max-width: 280px;
            flex-shrink: 0;
        }

        .credit-card:hover {
            border-color: rgba(212, 175, 55, 0.5);
            transform: translateY(-3px);
        }

        .credit-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .credit-icon {
            font-size: 1.5rem;
        }

        .credit-name {
            font-weight: bold;
            flex: 1;
        }

        .credit-status {
            font-size: 1.2rem;
        }

        .credit-status.ok {
            color: #00ff64;
        }

        .credit-status.warning {
            color: #ffc800;
        }

        .credit-status.critical {
            color: #ff6464;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .credit-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .credit-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff64, #d4af37);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .credit-fill.warning {
            background: linear-gradient(90deg, #ffc800, #ff9500);
        }

        .credit-fill.critical {
            background: linear-gradient(90deg, #ff6464, #cc0000);
        }

        .credit-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .reload-btn {
            color: #d4af37;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 5px 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            transition: all 0.3s;
        }

        .reload-btn:hover {
            background: rgba(212, 175, 55, 0.2);
        }

        .credit-edit {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .credit-edit input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 6px 10px;
            color: #fff;
            font-size: 0.85rem;
        }

        .credit-edit button {
            background: rgba(0, 255, 100, 0.2);
            border: 1px solid rgba(0, 255, 100, 0.3);
            color: #00ff64;
            border-radius: 5px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .credit-edit button:hover {
            background: rgba(0, 255, 100, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .admin-action-bar {
                flex-wrap: wrap;
            }
        }

        /* Admin Action Bar */
        .admin-action-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .admin-action-bar .admin-btn {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(184, 134, 11, 0.3));
            border: 2px solid #d4af37;
            padding: 15px 30px;
            color: #d4af37;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-action-bar .admin-btn:hover {
            background: linear-gradient(135deg, #d4af37, #b8860b);
            color: #0a0a1a;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4);
        }

        .admin-action-bar .admin-btn.traffic {
            border-color: #00ff64;
            color: #00ff64;
        }

        .admin-action-bar .admin-btn.traffic:hover {
            background: #00ff64;
            color: #0a0a1a;
        }

        .admin-action-bar .admin-btn.msg {
            border-color: #00bfff;
            color: #00bfff;
        }

        .admin-action-bar .admin-btn.msg:hover {
            background: #00bfff;
            color: #0a0a1a;
        }

        .admin-action-bar .admin-btn.msg-all {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .admin-action-bar .admin-btn.msg-all:hover {
            background: #ff6b6b;
            color: #0a0a1a;
        }

        .admin-action-bar .admin-btn.clients {
            border-color: #a855f7;
            color: #a855f7;
        }

        .admin-action-bar .admin-btn.clients:hover {
            background: #a855f7;
            color: #0a0a1a;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a3e, #0a0a1a);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .modal-title {
            font-size: 1.5rem;
            color: #d4af37;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        /* Traffic Table */
        .traffic-table {
            width: 100%;
            border-collapse: collapse;
        }

        .traffic-table th,
        .traffic-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .traffic-table th {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }

        .traffic-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .capture-thumb {
            width: 60px;
            height: 45px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Message Form */
        .msg-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg-form input,
        .msg-form textarea,
        .msg-form select {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 1rem;
        }

        .msg-form textarea {
            min-height: 120px;
            resize: vertical;
        }

        .msg-form button {
            background: linear-gradient(135deg, #d4af37, #b8860b);
            border: none;
            padding: 15px;
            color: #0a0a1a;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .msg-form button:hover {
            transform: scale(1.02);
        }

        .user-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-item:hover,
        .user-item.selected {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="login-container">
        <div class="login-box">
            <img src="images/kelion_blazon.png" alt="Kelion" class="login-logo" onerror="this.style.display='none'">
            <h1 class="login-title">Admin Panel</h1>
            <p class="login-subtitle">Kelion AI Management System</p>
            <button class="login-btn" onclick="netlifyIdentity.open('login')">
                üîê Login with Netlify Identity
            </button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <img src="images/kelion_blazon.png" alt="Kelion" class="header-logo"
                    onerror="this.style.display='none'">
                <span class="header-title">Kelion Admin</span>
            </div>
            <div class="user-info">
                <button class="logout-btn" onclick="window.location.href='/app.html'"
                    style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(184, 134, 11, 0.3)); border-color: rgba(212, 175, 55, 0.5); margin-right: 10px;">‚Üê
                    Back to K</button>
                <span class="user-email" id="user-email"></span>
                <button class="logout-btn" onclick="confirmExit()">üö™ Ie»ôire</button>
            </div>
        </div>

        <!-- Admin Action Bar -->
        <div class="admin-action-bar">
            <button class="admin-btn traffic" onclick="openTrafficModal()">
                üìä Traffic
            </button>
            <button class="admin-btn clients" onclick="openClientsModal()">
                üë• Clients
            </button>
            <button class="admin-btn msg" onclick="openMsgModal()">
                üí¨ MSG
            </button>
            <button class="admin-btn msg-all" onclick="openMsgAllModal()">
                üì¢ MSG All
            </button>
            <button class="admin-btn" onclick="window.location.href='marketing.html'"
                style="border-color: #a855f7; color: #a855f7;">
                üì£ Marketing AI
            </button>
            <button class="admin-btn" onclick="window.location.href='app.html'"
                style="background: linear-gradient(135deg, #00c853, #00a043);">
                ‚Üê √énapoi la K
            </button>
        </div>

        <!-- System Status Dashboard -->
        <div class="stats-grid" id="system-status-grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div class="stat-card"
                style="grid-column: span 2; padding: 20px; background: rgba(0,0,0,0.4); border-radius: 16px; border: 1px solid rgba(212,175,55,0.15);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h3 style="font-size:1rem;color:#d4af37">‚ö° System Status</h3>
                    <div style="display:flex;gap:8px;align-items:center">
                        <span id="sys-version"
                            style="padding:3px 10px;border-radius:20px;background:rgba(212,175,55,0.1);border:1px solid rgba(212,175,55,0.15);font-size:.7rem;color:#d4af37;font-weight:600">v--</span>
                        <button onclick="refreshSystemStatus()"
                            style="background:none;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:4px 10px;color:rgba(255,255,255,0.4);font-size:.7rem;cursor:pointer">üîÑ</button>
                    </div>
                </div>
                <div id="service-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
                <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
                    <span id="sys-timestamp" style="font-size:.65rem;color:rgba(255,255,255,0.2)">Last check: --</span>
                    <span id="sys-overall" style="font-size:.7rem;font-weight:600;color:#4ade80">‚óè All OK</span>
                </div>
            </div>
        </div>

        <script>
            async function refreshSystemStatus() {
                try {
                    const res = await fetch('/.netlify/functions/health-check');
                    const data = await res.json();
                    document.getElementById('sys-version').textContent = data.version || 'v?';
                    document.getElementById('sys-timestamp').textContent = 'Last check: ' + new Date(data.timestamp).toLocaleTimeString();

                    const grid = document.getElementById('service-grid');
                    grid.innerHTML = '';
                    let allOk = true;
                    for (const [name, info] of Object.entries(data.services || {})) {
                        const ok = info.configured;
                        if (!ok) allOk = false;
                        const el = document.createElement('div');
                        el.style.cssText = 'display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);font-size:.72rem';
                        el.innerHTML = '<span style="color:' + (ok ? '#4ade80' : '#f87171') + ';font-size:.8rem">‚óè</span><span style="color:rgba(255,255,255,0.5);text-transform:capitalize">' + name.replace('_', ' ') + '</span>';
                        grid.appendChild(el);
                    }
                    const overall = document.getElementById('sys-overall');
                    overall.textContent = allOk ? '‚óè All OK' : '‚ö† Issues';
                    overall.style.color = allOk ? '#4ade80' : '#f87171';
                } catch (e) {
                    document.getElementById('sys-overall').textContent = '‚úñ Offline';
                    document.getElementById('sys-overall').style.color = '#f87171';
                }
            }
            // Auto-load on dashboard show
            setTimeout(refreshSystemStatus, 500);
        </script>

        <!-- Financial Overview ‚Äî Real Cost/Revenue/Profit -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px">
            <!-- Costs Card -->
            <div
                style="padding:20px;background:rgba(0,0,0,0.4);border-radius:16px;border:1px solid rgba(248,113,113,0.1)">
                <div style="font-size:.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px">API COSTS</div>
                <div id="fin-costs" style="font-size:1.6rem;font-weight:600;color:#f87171">$0.00</div>
                <div style="margin-top:8px;font-size:.6rem;color:rgba(255,255,255,0.2)">
                    Free: <span id="fin-free">$0</span> ¬∑ Paid: <span id="fin-paid">$0</span>
                </div>
                <div id="fin-calls" style="font-size:.6rem;color:rgba(255,255,255,0.15);margin-top:2px">0 calls</div>
            </div>
            <!-- Revenue Card -->
            <div
                style="padding:20px;background:rgba(0,0,0,0.4);border-radius:16px;border:1px solid rgba(74,222,128,0.1)">
                <div style="font-size:.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px">REVENUE</div>
                <div id="fin-revenue" style="font-size:1.6rem;font-weight:600;color:#4ade80">$0.00</div>
                <div id="fin-txns" style="margin-top:8px;font-size:.6rem;color:rgba(255,255,255,0.2)">0 transactions
                </div>
            </div>
            <!-- Profit Card -->
            <div
                style="padding:20px;background:rgba(0,0,0,0.4);border-radius:16px;border:1px solid rgba(212,175,55,0.15)">
                <div style="font-size:.7rem;color:rgba(255,255,255,0.3);margin-bottom:4px">NET PROFIT</div>
                <div id="fin-profit" style="font-size:1.6rem;font-weight:600;color:#d4af37">$0.00</div>
                <div style="margin-top:8px;font-size:.6rem;color:rgba(255,255,255,0.2)">
                    Margin: <span id="fin-margin">0%</span>
                </div>
            </div>
        </div>
        <!-- Period selector + Model breakdown -->
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:20px">
            <span style="font-size:.7rem;color:rgba(255,255,255,0.3)">Period:</span>
            <button onclick="loadFinancials('today')" class="fin-period"
                style="padding:4px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:rgba(255,255,255,0.4);font-size:.65rem;cursor:pointer">Today</button>
            <button onclick="loadFinancials('7d')" class="fin-period"
                style="padding:4px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:rgba(255,255,255,0.4);font-size:.65rem;cursor:pointer">7
                Days</button>
            <button onclick="loadFinancials('30d')" class="fin-period"
                style="padding:4px 12px;border-radius:6px;border:1px solid rgba(212,175,55,0.15);background:rgba(212,175,55,0.05);color:#d4af37;font-size:.65rem;cursor:pointer">30
                Days</button>
            <button onclick="loadFinancials('all')" class="fin-period"
                style="padding:4px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:rgba(255,255,255,0.4);font-size:.65rem;cursor:pointer">All
                Time</button>
        </div>
        <div id="model-breakdown"
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:25px">
        </div>

        <script>
            async function loadFinancials(period = '30d') {
                try {
                    const res = await fetch('/.netlify/functions/cost-tracker', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'get_summary', period })
                    });
                    const data = await res.json();
                    if (!data.success) return;

                    document.getElementById('fin-costs').textContent = '$' + data.costs.total.toFixed(4);
                    document.getElementById('fin-free').textContent = '$' + data.costs.free_users.toFixed(4);
                    document.getElementById('fin-paid').textContent = '$' + data.costs.paid_users.toFixed(4);
                    document.getElementById('fin-calls').textContent = data.costs.total_calls + ' API calls';
                    document.getElementById('fin-revenue').textContent = '$' + data.revenue.total.toFixed(2);
                    document.getElementById('fin-txns').textContent = data.revenue.total_transactions + ' transactions';

                    const profitEl = document.getElementById('fin-profit');
                    profitEl.textContent = (data.profit >= 0 ? '+$' : '-$') + Math.abs(data.profit).toFixed(2);
                    profitEl.style.color = data.profit >= 0 ? '#4ade80' : '#f87171';

                    document.getElementById('fin-margin').textContent = data.margin_percent + '%';

                    // Model breakdown
                    const mbDiv = document.getElementById('model-breakdown');
                    mbDiv.innerHTML = '';
                    for (const [model, info] of Object.entries(data.costs.by_model || {})) {
                        const el = document.createElement('div');
                        el.style.cssText = 'padding:10px;border-radius:10px;background:rgba(255,255,255,0.015);border:1px solid rgba(255,255,255,0.03)';
                        el.innerHTML = '<div style="font-size:.65rem;color:rgba(255,255,255,0.3);text-transform:capitalize">' + model + '</div>' +
                            '<div style="font-size:.9rem;font-weight:600;color:#f87171;margin-top:2px">$' + info.cost.toFixed(4) + '</div>' +
                            '<div style="font-size:.55rem;color:rgba(255,255,255,0.15)">' + info.calls + ' calls</div>';
                        mbDiv.appendChild(el);
                    }
                } catch (e) { console.error('Financial load error:', e); }
            }
            setTimeout(() => loadFinancials('30d'), 800);
        </script>

        <!-- üìã Financial Milestones & Obligations Tracker -->
        <h2 class="section-title" style="margin-top:15px">üìã Financial Milestones & Tax Obligations</h2>
        <div id="milestones-panel" style="margin-bottom:25px">
            <div style="display:grid;grid-template-columns:1fr;gap:10px" id="milestones-list"></div>
        </div>
        <script>
            (function () {
                const MILESTONES = [
                    {
                        id: 'breakeven',
                        title: 'üéØ Breakeven ‚Äî 5 plƒÉtitori Pro',
                        desc: 'Cu 5 useri Pro (¬£15/mo), acoperi fixed costs (¬£45) + API costs',
                        threshold: 5,
                        metric: 'paid_users',
                        urgency: 'info',
                        action: 'Focus pe achizi»õie: social media, Product Hunt, Reddit'
                    },
                    {
                        id: 'vat_watch',
                        title: '‚ö†Ô∏è VAT Registration ‚Äî ¬£90,000/yr revenue',
                        desc: 'C√¢nd depƒÉ»ôe»ôti ¬£90k revenue/yr, TREBUIE sƒÉ te √Ænregistrezi pt VAT (20%)',
                        threshold: 90000,
                        metric: 'annual_revenue',
                        urgency: 'warning',
                        action: 'ContacteazƒÉ un contabil UK. √énregistrare la HMRC. AdaugƒÉ VAT 20% la pre»õuri.'
                    },
                    {
                        id: 'corp_tax',
                        title: 'üèõÔ∏è Corporation Tax ‚Äî 19% under ¬£50k profit',
                        desc: 'Corp Tax se plƒÉte»ôte anual pe profit. Anul fiscal: Apr‚ÄìMar. Filing deadline: 12 luni dupƒÉ.',
                        threshold: 0,
                        metric: 'always',
                        urgency: 'info',
                        action: '»öine eviden»õa cheltuielilor. Filing la Companies House + HMRC. Deadline: 9 luni dupƒÉ year-end.'
                    },
                    {
                        id: 'cost_alert',
                        title: 'üî¥ Cost Alert ‚Äî API costs > 50% of revenue',
                        desc: 'DacƒÉ costul API depƒÉ»ôe»ôte 50% din revenue, marjele devin nesustenabile',
                        threshold: 50,
                        metric: 'cost_ratio',
                        urgency: 'danger',
                        action: 'ActiveazƒÉ usage limits, verificƒÉ heavy users, optimizeazƒÉ caching'
                    },
                    {
                        id: 'growth_10',
                        title: 'üöÄ 10 useri plƒÉtitori ‚Äî Confort zone',
                        desc: 'La 10 useri Pro: +¬£78/mo profit net. Stabilitate financiarƒÉ minimƒÉ.',
                        threshold: 10,
                        metric: 'paid_users',
                        urgency: 'info',
                        action: 'Investe»ôte √Æn marketing: Google Ads, content marketing'
                    },
                    {
                        id: 'growth_50',
                        title: 'üí∞ 50 useri plƒÉtitori ‚Äî Revenue ¬£750/mo',
                        desc: 'Profit net: ~¬£463/mo (after 19% Corp Tax). Suficient pt 1 salary minimal.',
                        threshold: 50,
                        metric: 'paid_users',
                        urgency: 'info',
                        action: 'ConsiderƒÉ angajarea unui freelancer. NegociazƒÉ volume discounts cu API providers.'
                    },
                    {
                        id: 'growth_200',
                        title: 'üèÜ 200 useri ‚Äî ¬£3k/mo revenue',
                        desc: 'Profit: ~¬£1,964/mo net. VerificƒÉ dacƒÉ trebuie VAT. Business real.',
                        threshold: 200,
                        metric: 'paid_users',
                        urgency: 'info',
                        action: 'AngajeazƒÉ contabil. EvalueazƒÉ self-hosted TTS. Extinde echipa.'
                    }
                ];

                function renderMilestones(stats) {
                    const el = document.getElementById('milestones-list');
                    if (!el) return;
                    el.innerHTML = '';

                    // Estimate current values (from Supabase or manual)
                    const paidUsers = stats?.paid_users || 0;
                    const monthlyRevenue = stats?.monthly_revenue || 0;
                    const annualRevenue = monthlyRevenue * 12;
                    const monthlyCosts = stats?.monthly_costs || 0;
                    const costRatio = monthlyRevenue > 0 ? (monthlyCosts / monthlyRevenue) * 100 : 0;

                    MILESTONES.forEach(m => {
                        let progress = 0, status = 'pending', statusText = '';

                        if (m.metric === 'paid_users') {
                            progress = Math.min(100, (paidUsers / m.threshold) * 100);
                            statusText = `${paidUsers}/${m.threshold} useri`;
                            if (paidUsers >= m.threshold) status = 'done';
                            else if (paidUsers >= m.threshold * 0.7) status = 'approaching';
                        } else if (m.metric === 'annual_revenue') {
                            progress = Math.min(100, (annualRevenue / m.threshold) * 100);
                            statusText = `¬£${annualRevenue.toLocaleString()}/¬£${m.threshold.toLocaleString()}`;
                            if (annualRevenue >= m.threshold) status = 'urgent';
                            else if (annualRevenue >= m.threshold * 0.8) status = 'approaching';
                        } else if (m.metric === 'cost_ratio') {
                            progress = Math.min(100, costRatio);
                            statusText = `${costRatio.toFixed(0)}%/${m.threshold}%`;
                            if (costRatio > m.threshold) status = 'urgent';
                            else if (costRatio > m.threshold * 0.8) status = 'approaching';
                        } else if (m.metric === 'always') {
                            status = 'info';
                            statusText = 'Always applicable';
                            progress = 0;
                        }

                        const colors = {
                            done: { bg: 'rgba(74,222,128,0.06)', border: 'rgba(74,222,128,0.12)', badge: '#4ade80', text: '‚úÖ DONE' },
                            approaching: { bg: 'rgba(251,191,36,0.06)', border: 'rgba(251,191,36,0.12)', badge: '#fbbf24', text: '‚è∞ APPROACHING' },
                            urgent: { bg: 'rgba(248,113,113,0.08)', border: 'rgba(248,113,113,0.15)', badge: '#f87171', text: 'üö® ACTION NEEDED' },
                            info: { bg: 'rgba(96,165,250,0.04)', border: 'rgba(96,165,250,0.08)', badge: '#60a5fa', text: '‚ÑπÔ∏è INFO' },
                            pending: { bg: 'rgba(255,255,255,0.02)', border: 'rgba(255,255,255,0.04)', badge: 'rgba(255,255,255,0.2)', text: '‚¨ú PENDING' }
                        };
                        const c = colors[status] || colors.pending;

                        const div = document.createElement('div');
                        div.style.cssText = `padding:15px 18px;border-radius:14px;background:${c.bg};border:1px solid ${c.border};transition:all .2s`;
                        div.innerHTML = `
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                                <div style="font-size:.85rem;font-weight:600;color:rgba(255,255,255,0.85)">${m.title}</div>
                                <span style="font-size:.55rem;padding:3px 8px;border-radius:20px;background:${c.bg};border:1px solid ${c.border};color:${c.badge};font-weight:700">${c.text}</span>
                            </div>
                            <div style="font-size:.7rem;color:rgba(255,255,255,0.35);margin-bottom:8px">${m.desc}</div>
                            ${m.metric !== 'always' ? `
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
                                <div style="flex:1;height:4px;border-radius:4px;background:rgba(255,255,255,0.05)">
                                    <div style="height:100%;border-radius:4px;background:${c.badge};width:${progress}%;transition:width .5s"></div>
                                </div>
                                <span style="font-size:.6rem;color:rgba(255,255,255,0.3);min-width:80px;text-align:right">${statusText}</span>
                            </div>` : ''}
                            ${(status === 'approaching' || status === 'urgent') ? `
                            <div style="font-size:.65rem;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.2);color:${c.badge};margin-top:4px">
                                <strong>ACTION:</strong> ${m.action}
                            </div>` : `
                            <details style="margin-top:4px">
                                <summary style="font-size:.6rem;color:rgba(255,255,255,0.2);cursor:pointer">When needed ‚Üí</summary>
                                <div style="font-size:.6rem;padding:6px 10px;margin-top:4px;border-radius:6px;background:rgba(0,0,0,0.15);color:rgba(255,255,255,0.3)">${m.action}</div>
                            </details>`}
                        `;
                        el.appendChild(div);
                    });
                }

                // Initial render with 0 values, will update when real data arrives
                renderMilestones({ paid_users: 0, monthly_revenue: 0, monthly_costs: 0 });

                // Try to get real stats
                async function loadMilestoneData() {
                    try {
                        const res = await fetch('/.netlify/functions/cost-tracker', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'get_summary', period: '30d' })
                        });
                        const data = await res.json();
                        if (data.revenue || data.costs) {
                            renderMilestones({
                                paid_users: data.revenue?.total_transactions || 0,
                                monthly_revenue: data.revenue?.total || 0,
                                monthly_costs: data.costs?.total || 0
                            });
                        }
                    } catch (e) { /* milestones stay at 0 */ }
                }
                setTimeout(loadMilestoneData, 1200);
            })();
        </script>

        <!-- üìä Top Users by Usage (Today) -->
        <h2 class="section-title" style="margin-top:15px">üìä Top Users by Usage (Today)</h2>
        <div id="top-users-panel" style="margin-bottom:25px">
            <div id="top-users-list" style="display:grid;gap:6px">
                <div style="color:rgba(255,255,255,0.2);font-size:.7rem;padding:10px">Loading usage data...</div>
            </div>
        </div>
        <script>
            (async function () {
                try {
                    const res = await fetch('/.netlify/functions/usage-limiter', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'top_users' })
                    });
                    const data = await res.json();
                    const el = document.getElementById('top-users-list');
                    if (!data.top_users || data.top_users.length === 0) {
                        el.innerHTML = '<div style="color:rgba(255,255,255,0.2);font-size:.7rem;padding:10px">No usage data today yet</div>';
                        return;
                    }
                    el.innerHTML = '';
                    data.top_users.slice(0, 10).forEach((u, i) => {
                        const eps = Object.entries(u.endpoints || {}).map(([k, v]) => `${k}: ${v}`).join(' ¬∑ ');
                        const div = document.createElement('div');
                        div.style.cssText = 'padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);display:flex;justify-content:space-between;align-items:center';
                        div.innerHTML = `
                            <div>
                                <span style="font-size:.75rem;color:rgba(255,255,255,0.6);font-weight:600">${i + 1}. ${u.email}</span>
                                <div style="font-size:.55rem;color:rgba(255,255,255,0.2);margin-top:2px">${eps}</div>
                            </div>
                            <span style="font-size:.85rem;font-weight:700;color:${u.total > 50 ? '#f87171' : u.total > 20 ? '#fbbf24' : '#4ade80'}">${u.total}</span>
                        `;
                        el.appendChild(div);
                    });
                } catch (e) { document.getElementById('top-users-list').innerHTML = '<div style="color:#f87171;font-size:.6rem;padding:10px">Error loading usage data</div>'; }
            })();
        </script>

        <!-- AI Credits Dashboard -->
        <h2 class="section-title">üí≥ AI Credits</h2>
        <div class="credits-grid" id="credits-grid">
            <div class="credit-card" id="credit-openai">
                <div class="credit-header">
                    <span class="credit-icon">ü§ñ</span>
                    <span class="credit-name">OpenAI</span>
                    <span class="credit-status ok" id="openai-status">‚óè</span>
                </div>
                <div class="credit-bar">
                    <div class="credit-fill" id="openai-fill" style="width: 0%"></div>
                </div>
                <div class="credit-info">
                    <span id="openai-balance">Check balance ‚Üí</span>
                    <a href="https://platform.openai.com/settings/organization/billing/overview" target="_blank"
                        class="reload-btn">Re√ÆncarcƒÉ ‚Üí</a>
                </div>
                <div class="credit-edit">
                    <input type="number" id="openai-used" placeholder="Folosit $" style="width: 80px;">
                    <input type="number" id="openai-limit" placeholder="LimitƒÉ $" style="width: 80px;">
                    <button onclick="updateCredit('openai')">üíæ</button>
                </div>
            </div>

            <div class="credit-card" id="credit-elevenlabs">
                <div class="credit-header">
                    <span class="credit-icon">üîä</span>
                    <span class="credit-name">ElevenLabs</span>
                    <span class="credit-status ok" id="elevenlabs-status">‚óè</span>
                </div>
                <div class="credit-bar">
                    <div class="credit-fill" id="elevenlabs-fill" style="width: 50%"></div>
                </div>
                <div class="credit-info">
                    <span id="elevenlabs-balance">Checking...</span>
                    <a href="https://elevenlabs.io/subscription" target="_blank" class="reload-btn">Re√ÆncarcƒÉ ‚Üí</a>
                </div>
            </div>

            <div class="credit-card" id="credit-deepgram">
                <div class="credit-header">
                    <span class="credit-icon">üé§</span>
                    <span class="credit-name">Deepgram</span>
                    <span class="credit-status ok" id="deepgram-status">‚óè</span>
                </div>
                <div class="credit-bar">
                    <div class="credit-fill" id="deepgram-fill" style="width: 0%"></div>
                </div>
                <div class="credit-info">
                    <span id="deepgram-balance">Check balance ‚Üí</span>
                    <a href="https://console.deepgram.com/billing" target="_blank" class="reload-btn">Re√ÆncarcƒÉ ‚Üí</a>
                </div>
                <div class="credit-edit">
                    <input type="number" id="deepgram-used" placeholder="Folosit $" style="width: 80px;">
                    <input type="number" id="deepgram-limit" placeholder="LimitƒÉ $" style="width: 80px;">
                    <button onclick="updateCredit('deepgram')">üíæ</button>
                </div>
            </div>

            <div class="credit-card" id="credit-supabase">
                <div class="credit-header">
                    <span class="credit-icon">üóÑÔ∏è</span>
                    <span class="credit-name">Supabase</span>
                    <span class="credit-status ok" id="supabase-status">‚óè</span>
                </div>
                <div class="credit-bar">
                    <div class="credit-fill" id="supabase-fill" style="width: 100%"></div>
                </div>
                <div class="credit-info">
                    <span id="supabase-balance">Free Tier</span>
                    <a href="https://supabase.com/dashboard" target="_blank" class="reload-btn">Dashboard ‚Üí</a>
                </div>
            </div>

            <!-- Gemini AI -->
            <div class="credit-card" id="credit-gemini">
                <div class="credit-header">
                    <span class="credit-icon">üß†</span>
                    <span class="credit-name">Gemini</span>
                    <span class="credit-status ok" id="gemini-status">‚óè</span>
                </div>
                <div class="credit-bar">
                    <div class="credit-fill" id="gemini-fill" style="width: 100%"></div>
                </div>
                <div class="credit-info">
                    <span id="gemini-balance">Free Tier</span>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="reload-btn">API Keys ‚Üí</a>
                </div>
            </div>

            <!-- Kimi AI -->
            <div class="credit-card" id="credit-kimi">
                <div class="credit-header">
                    <span class="credit-icon">üåô</span>
                    <span class="credit-name">Kimi (Moonshot)</span>
                    <span class="credit-status ok" id="kimi-status">‚óè</span>
                </div>
                <div class="credit-bar">
                    <div class="credit-fill" id="kimi-fill" style="width: 0%"></div>
                </div>
                <div class="credit-info">
                    <span id="kimi-balance">Checking...</span>
                    <a href="https://platform.moonshot.cn/" target="_blank" class="reload-btn">Dashboard ‚Üí</a>
                </div>
            </div>

            <!-- Replicate -->
            <div class="credit-card" id="credit-replicate">
                <div class="credit-header">
                    <span class="credit-icon">üé¨</span>
                    <span class="credit-name">Replicate</span>
                    <span class="credit-status ok" id="replicate-status">‚óè</span>
                </div>
                <div class="credit-bar">
                    <div class="credit-fill" id="replicate-fill" style="width: 0%"></div>
                </div>
                <div class="credit-info">
                    <span id="replicate-balance">Checking...</span>
                    <a href="https://replicate.com/account" target="_blank" class="reload-btn">Dashboard ‚Üí</a>
                </div>
            </div>
        </div>

        <!-- API Status - HIDDEN -->
        <div style="display: none;">
            <h2 class="section-title">API Status</h2>
            <div class="status-grid" id="api-status-grid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div> <!-- Close hidden API Status -->

        <!-- Environment Variables - HIDDEN -->
        <div style="display: none;">
            <h2 class="section-title">Environment Variables</h2>
            <table class="env-table">
                <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Purpose</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="env-table-body">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div> <!-- Close hidden Env Variables -->

        <!-- Quick Actions - HIDDEN -->
        <div style="display: none;">
            <h2 class="section-title">Quick Actions</h2>
            <div class="actions-grid">
                <button class="action-btn primary" onclick="testAllAPIs()">
                    <div class="action-icon">üîÑ</div>
                    <div>Test All APIs</div>
                </button>
                <button class="action-btn" onclick="window.open('/', '_blank')">
                    <div class="action-icon">üîÆ</div>
                    <div>View Hologram</div>
                </button>
                <button class="action-btn" onclick="window.open('https://app.netlify.com', '_blank')">
                    <div class="action-icon">‚öôÔ∏è</div>
                    <div>Netlify Dashboard</div>
                </button>
                <button class="action-btn" onclick="exportLogs()">
                    <div class="action-icon">üìä</div>
                    <div>Export Logs</div>
                </button>
            </div>
        </div> <!-- Close hidden Quick Actions -->
    </div>

    <!-- Traffic Modal -->
    <div class="modal-overlay" id="traffic-modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 class="modal-title">üìä Live Traffic Dashboard</h2>
                <button class="modal-close" onclick="closeModal('traffic-modal')">&times;</button>
            </div>

            <!-- Summary Stats -->
            <div id="traffic-stats" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                    <div
                        style="background: rgba(0,255,100,0.1); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(0,255,100,0.2);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #00ff64;" id="stat-total-views">0</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Total Views</div>
                    </div>
                    <div
                        style="background: rgba(0,191,255,0.1); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(0,191,255,0.2);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #00bfff;" id="stat-unique">0</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Unique Visitors</div>
                    </div>
                    <div
                        style="background: rgba(212,175,55,0.1); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(212,175,55,0.2);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #d4af37;" id="stat-period">--</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Period</div>
                    </div>
                </div>
                <!-- Countries breakdown -->
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="color: #d4af37; font-size: 0.8rem; margin-bottom: 8px;">üåç By Country</div>
                        <div id="stat-countries" style="font-size: 0.85rem; color: rgba(255,255,255,0.7);"></div>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <div style="color: #d4af37; font-size: 0.8rem; margin-bottom: 8px;">üì± By Device</div>
                        <div id="stat-devices" style="font-size: 0.85rem; color: rgba(255,255,255,0.7);"></div>
                    </div>
                </div>
            </div>

            <div id="traffic-loading"><span class="spinner"></span> Loading traffic data...</div>
            <table class="traffic-table" id="traffic-table" style="display:none;">
                <thead>
                    <tr>
                        <th colspan="4" style="background: rgba(212, 175, 55, 0.1); color: #d4af37; padding: 15px;">
                            üìä Visitor Details (Real-time Analytics)
                        </th>
                    </tr>
                </thead>
                <tbody id="traffic-body"></tbody>
            </table>
        </div>
    </div>

    <!-- MSG Modal -->
    <div class="modal-overlay" id="msg-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí¨ Send Message to User</h2>
                <button class="modal-close" onclick="closeModal('msg-modal')">&times;</button>
            </div>
            <div class="msg-form">
                <label>Select User:</label>
                <div class="user-list" id="user-list">
                    <div style="color: rgba(255,255,255,0.5);">Loading users from traffic...</div>
                </div>
                <textarea id="msg-content" placeholder="Type your message here..."></textarea>
                <button onclick="sendMessage()">üì§ Send Message</button>
            </div>
        </div>
    </div>

    <!-- MSG All Modal -->
    <div class="modal-overlay" id="msg-all-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì¢ Broadcast to All Users</h2>
                <button class="modal-close" onclick="closeModal('msg-all-modal')">&times;</button>
            </div>
            <div class="msg-form">
                <textarea id="msg-all-content" placeholder="Type broadcast message..."></textarea>
                <button onclick="sendBroadcast()">üì¢ Send to All</button>
            </div>
        </div>
    </div>

    <!-- Clients Modal -->
    <div class="modal-overlay" id="clients-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">üë• Client Database</h2>
                <button class="modal-close" onclick="closeModal('clients-modal')">&times;</button>
            </div>
            <div id="clients-loading"><span class="spinner"></span> Loading clients...</div>
            <div id="clients-stats" style="display:none; margin-bottom: 20px;">
                <span
                    style="background: rgba(0,255,100,0.2); padding: 5px 15px; border-radius: 20px; margin-right: 10px;">
                    Total: <strong id="clients-total">0</strong>
                </span>
                <span
                    style="background: rgba(212,175,55,0.2); padding: 5px 15px; border-radius: 20px; margin-right: 10px;">
                    Premium: <strong id="clients-premium">0</strong>
                </span>
                <span style="background: rgba(0,191,255,0.2); padding: 5px 15px; border-radius: 20px;">
                    Admin: <strong id="clients-admin">0</strong>
                </span>
            </div>
            <table class="traffic-table" id="clients-table" style="display:none;">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Subscription</th>
                        <th>Creat</th>
                        <th>Ac»õiuni</th>
                    </tr>
                </thead>
                <tbody id="clients-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        console.log('üõ°Ô∏è ADMIN.HTML LOADED - Version 2.1 - Credits Dashboard');

        // ============ AI CREDITS FUNCTIONS ============
        async function loadCredits() {
            console.log('üí≥ Loading AI credits...');
            try {
                const response = await fetch('/.netlify/functions/ai-credits');
                if (!response.ok) throw new Error('Credits API failed');

                const data = await response.json();
                console.log('üí≥ Credits data:', data);

                // Update each service card
                Object.entries(data.services || {}).forEach(([service, info]) => {
                    const statusEl = document.getElementById(`${service}-status`);
                    const fillEl = document.getElementById(`${service}-fill`);
                    const balanceEl = document.getElementById(`${service}-balance`);

                    if (!statusEl) return;

                    // Update status indicator
                    statusEl.className = `credit-status ${info.status || 'ok'}`;

                    // Update progress bar
                    if (fillEl && info.percentage !== undefined) {
                        fillEl.style.width = `${info.percentage}%`;
                        fillEl.className = `credit-fill ${info.status || 'ok'}`;
                    }

                    // Update balance text
                    if (balanceEl) {
                        if (info.remaining !== undefined && info.limit !== undefined) {
                            balanceEl.textContent = `${info.remaining} / ${info.limit}`;
                        } else if (info.message) {
                            balanceEl.textContent = info.message;
                        }
                    }
                });

                // Show alerts if any
                if (data.alerts && data.alerts.length > 0) {
                    data.alerts.forEach(alert => {
                        console.warn(`‚ö†Ô∏è Credit alert: ${alert.service} - ${alert.status}: ${alert.message}`);
                    });
                }
            } catch (e) {
                console.error('Credits load error:', e);
            }
        }

        async function updateCredit(service) {
            const usedEl = document.getElementById(`${service}-used`);
            const limitEl = document.getElementById(`${service}-limit`);

            const used = parseFloat(usedEl?.value) || 0;
            const limit = parseFloat(limitEl?.value);

            if (!limit) {
                alert('Te rog introdu limita bugetului!');
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/ai-credits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service,
                        used_amount: used,
                        budget_limit: limit
                    })
                });

                if (!response.ok) throw new Error('Update failed');

                const data = await response.json();
                console.log('‚úÖ Credit updated:', data);

                // Reload credits display
                loadCredits();

                // Clear inputs
                if (usedEl) usedEl.value = '';
                if (limitEl) limitEl.value = '';

                alert(`${service} actualizat cu succes!`);
            } catch (e) {
                console.error('Credit update error:', e);
                alert('Update error: ' + e.message);
            }
        }


        // Auto-login check (wrap in IIFE so return works)
        (function () {
            const kelionUser = localStorage.getItem('kelion_user');
            if (kelionUser) {
                try {
                    const userData = JSON.parse(kelionUser);
                    const adminEmails = ['admin@kelionai.app', 'adrianenc11@gmail.com'];
                    if (adminEmails.includes(userData.email?.toLowerCase())) {
                        console.log('‚úÖ Admin auto-login:', userData.email);
                        // Hide login, show dashboard
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('dashboard-container').style.display = 'block';
                        showDashboard({ email: userData.email, user_metadata: { full_name: userData.email } });
                        return;
                    }
                } catch (e) {
                    console.warn('Failed to parse kelion_user:', e);
                }
            }

            // Only init Netlify Identity if NOT auto-logged in
            netlifyIdentity.on('init', user => {
                if (user) {
                    showDashboard(user);
                }
            });
        })();

        // Check if admin by IP first (auto-login for known admin)
        async function checkAdminByIP() {
            try {
                const response = await fetch('/.netlify/functions/check-user', {
                    headers: { 'X-Fingerprint': getFingerprint() }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.hasSubscription && data.email) {
                        // Check if this is admin email
                        const adminEmails = ['admin@kelionai.app'];
                        if (adminEmails.includes(data.email.toLowerCase())) {
                            console.log('üîê Admin recognized by IP:', data.email);
                            showDashboard({ email: data.email });
                            return true;
                        }
                    }
                }
            } catch (e) {
                console.log('IP check failed, using normal login');
            }
            return false;
        }

        function getFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fp', 0, 0);
            return canvas.toDataURL().slice(-20) + navigator.language + screen.width;
        }

        // Check if already logged in via main app (localStorage)
        function checkMainAppLogin() {
            const authToken = localStorage.getItem('kelion_auth_token');
            const userEmail = localStorage.getItem('kelion_user_email');
            const userStr = localStorage.getItem('kelion_user');

            if (authToken && userEmail) {
                try {
                    const user = userStr ? JSON.parse(userStr) : {};
                    const role = user.role || '';

                    // Check if admin or superadmin
                    if (role === 'admin' || role === 'superadmin' || userEmail === 'admin@kelionai.app') {
                        console.log('üîê Admin already logged in via main app:', userEmail);
                        showDashboard({ email: userEmail, role: role });
                        return true;
                    }
                } catch (e) {
                    console.warn('Could not parse user data:', e);
                }
            }
            return false;
        }

        // Check main app login FIRST before anything else
        if (checkMainAppLogin()) {
            console.log('‚úÖ Skipping Netlify Identity - using main app login');
        } else {
            // Try IP-based auto-login
            checkAdminByIP().then(isAdmin => {
                if (!isAdmin) {
                    // Fall back to Netlify Identity
                    netlifyIdentity.on('login', user => {
                        console.log('üîê Login successful:', user.email);
                        netlifyIdentity.close();
                        if (!window.location.pathname.includes('admin')) {
                            window.location.href = '/admin.html';
                        } else {
                            window.location.reload();
                        }
                    });

                    netlifyIdentity.on('logout', () => {
                        showLogin();
                    });

                    netlifyIdentity.init();

                    // Check if already logged in via Netlify
                    const user = netlifyIdentity.currentUser();
                    if (user) {
                        showDashboard(user);
                    }
                }
            });
        }

        function showLogin() {
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('dashboard-container').style.display = 'none';
        }

        function showDashboard(user) {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
            document.getElementById('user-email').textContent = user.email;

            // Load dashboard data
            loadAPIStatus();
            loadEnvStatus();
            loadCredits();  // Load AI credits
        }

        function logout() {
            netlifyIdentity.logout();
        }

        // Track if changes were made
        let hasUnsavedChanges = false;

        // Exit confirmation
        function confirmExit() {
            // Create exit confirmation modal
            const existingModal = document.getElementById('exit-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'exit-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
                    <div style="background: linear-gradient(135deg, #1a1a2e, #0a0a1a); border: 2px solid #d4af37; border-radius: 20px; padding: 30px 40px; max-width: 400px; text-align: center; color: #fff;">
                        <h3 style="color: #d4af37; margin: 0 0 15px;">üö™ Ie»ôire din Admin Panel</h3>
                        <p style="color: #aaa; margin: 0 0 25px;">Dori»õi sƒÉ salva»õi modificƒÉrile √Ænainte de a ie»ôi?</p>
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exitWithSave()" style="background: linear-gradient(135deg, #00ff88, #00cc6a); border: none; padding: 12px 25px; border-radius: 25px; color: #000; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                                ‚úÖ SalveazƒÉ »ôi Ie»ôi
                            </button>
                            <button onclick="exitWithoutSave()" style="background: linear-gradient(135deg, #ff6b6b, #ff4444); border: none; padding: 12px 25px; border-radius: 25px; color: #fff; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                                ‚ùå Renun»õƒÉ la ModificƒÉri
                            </button>
                            <button onclick="cancelExit()" style="background: transparent; border: 1px solid #666; padding: 12px 25px; border-radius: 25px; color: #888; cursor: pointer; transition: all 0.3s;">
                                üîô AnuleazƒÉ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function exitWithSave() {
            // Save any pending changes here if needed
            console.log('üíæ ModificƒÉri salvate');
            document.getElementById('exit-modal')?.remove();
            // Redirect to app
            window.location.href = '/app.html';
        }

        function exitWithoutSave() {
            console.log('üóëÔ∏è ModificƒÉri abandonate');
            document.getElementById('exit-modal')?.remove();
            // Redirect to app without saving
            window.location.href = '/app.html';
        }

        function cancelExit() {
            document.getElementById('exit-modal')?.remove();
        }

        // API Status Check
        async function loadAPIStatus() {
            const apis = [
                { name: 'Chat API (LLM)', endpoint: '/api/chat', method: 'POST', body: { messages: [{ role: 'user', content: 'ping' }] } },
                { name: 'Speak API (TTS)', endpoint: '/api/speak', method: 'POST', body: { text: 'test' } },
                { name: 'Search API', endpoint: '/api/search', method: 'POST', body: { query: 'test' } }
            ];

            const grid = document.getElementById('api-status-grid');
            grid.innerHTML = apis.map(api => `
                <div class="status-card" id="status-${api.name.replace(/\s/g, '')}">
                    <div class="status-header">
                        <span class="status-name">${api.name}</span>
                        <span class="status-badge checking"><span class="spinner"></span>Checking...</span>
                    </div>
                    <div class="status-detail">Endpoint: ${api.endpoint}</div>
                </div>
            `).join('');

            // Test each API
            for (const api of apis) {
                try {
                    const response = await fetch(api.endpoint, {
                        method: api.method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(api.body)
                    });

                    const card = document.getElementById(`status-${api.name.replace(/\s/g, '')}`);
                    const badge = card.querySelector('.status-badge');
                    const detail = card.querySelector('.status-detail');

                    if (response.ok) {
                        badge.className = 'status-badge online';
                        badge.textContent = '‚úì Online';
                        detail.textContent = `Response: ${response.status} OK`;
                    } else {
                        const data = await response.json().catch(() => ({}));
                        badge.className = 'status-badge offline';
                        badge.textContent = `‚úó Error ${response.status}`;
                        detail.textContent = data.error || `HTTP ${response.status}`;
                    }
                } catch (error) {
                    const card = document.getElementById(`status-${api.name.replace(/\s/g, '')}`);
                    const badge = card.querySelector('.status-badge');
                    badge.className = 'status-badge offline';
                    badge.textContent = '‚úó Failed';
                }
            }
        }

        // Environment Variables Status
        async function loadEnvStatus() {
            const envVars = [
                { name: 'LLM_API_KEY', purpose: 'AI Chat Intelligence (Groq)', fallback: 'GROQ_API_KEY' },
                { name: 'TTS_API_KEY', purpose: 'Text-to-Speech (ElevenLabs)', fallback: 'ELEVENLABS_API_KEY' },
                { name: 'SEARCH_API_KEY', purpose: 'Web Search (Perplexity)', fallback: 'PERPLEXITY_API_KEY' },
                { name: 'DB_URL', purpose: 'Database Connection', fallback: null },
                { name: 'VECTOR_DB_API_KEY', purpose: 'Semantic Memory', fallback: null },
                { name: 'ENCRYPTION_KEY', purpose: 'Data Encryption', fallback: null },
                { name: 'JWT_SIGNING_KEY', purpose: 'Session Management', fallback: null }
            ];

            const tbody = document.getElementById('env-table-body');
            tbody.innerHTML = envVars.map(env => `
                <tr>
                    <td><code>${env.name}</code>${env.fallback ? `<br><small style="color: #888">fallback: ${env.fallback}</small>` : ''}</td>
                    <td>${env.purpose}</td>
                    <td><span class="env-status checking"></span>Checking...</td>
                </tr>
            `).join('');

            // Fetch real env status from API
            try {
                const user = netlifyIdentity.currentUser();
                if (!user) {
                    // No user, show unknown status
                    updateEnvStatusUI(envVars, tbody, null);
                    return;
                }

                const token = await user.jwt();
                const response = await fetch('/.netlify/functions/env-check', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateEnvStatusUI(envVars, tbody, data.environment);
                } else {
                    // API error, show as unknown
                    updateEnvStatusUI(envVars, tbody, null);
                }
            } catch (error) {
                console.error('Env check error:', error);
                updateEnvStatusUI(envVars, tbody, null);
            }
        }

        function updateEnvStatusUI(envVars, tbody, envData) {
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, i) => {
                const statusCell = row.cells[2];
                const varName = envVars[i].name;

                if (envData && envData[varName]) {
                    if (envData[varName].configured) {
                        statusCell.innerHTML = '<span class="env-status configured"></span>Configured';
                    } else {
                        statusCell.innerHTML = '<span class="env-status missing"></span>Not Set';
                    }
                } else {
                    // No data available - mark as unknown
                    statusCell.innerHTML = '<span class="env-status checking"></span>Unknown';
                }
            });
        }

        // Load Stats (placeholder - would need actual backend)
        function loadStats() {
            // Placeholder values
            document.getElementById('stat-conversations').textContent = '--';
            document.getElementById('stat-voice').textContent = '--';
            document.getElementById('stat-languages').textContent = '25+';
            document.getElementById('stat-uptime').textContent = '99.9%';
        }

        // ============ AI CREDITS FUNCTIONS ============
        async function loadCredits() {
            try {
                const response = await fetch('/.netlify/functions/ai-credits');
                const data = await response.json();

                if (data.success && data.credits) {
                    const providers = {
                        openai: { fillId: 'openai-fill', balId: 'openai-balance', statusId: 'openai-status' },
                        elevenlabs: { fillId: 'elevenlabs-fill', balId: 'elevenlabs-balance', statusId: 'elevenlabs-status' },
                        deepgram: { fillId: 'deepgram-fill', balId: 'deepgram-balance', statusId: 'deepgram-status' },
                        supabase: { fillId: 'supabase-fill', balId: 'supabase-balance', statusId: 'supabase-status' },
                        gemini: { fillId: 'gemini-fill', balId: 'gemini-balance', statusId: 'gemini-status' },
                        deepseek: { fillId: 'deepseek-fill', balId: 'deepseek-balance', statusId: 'deepseek-status' },
                        kimi: { fillId: 'kimi-fill', balId: 'kimi-balance', statusId: 'kimi-status' },
                        replicate: { fillId: 'replicate-fill', balId: 'replicate-balance', statusId: 'replicate-status' }
                    };

                    Object.entries(data.credits).forEach(([key, info]) => {
                        const p = providers[key];
                        if (!p) return;

                        const statusEl = document.getElementById(p.statusId);
                        const fillEl = document.getElementById(p.fillId);
                        const balEl = document.getElementById(p.balId);

                        if (statusEl) {
                            statusEl.className = 'credit-status';
                            if (info.status === 'active') statusEl.classList.add('ok');
                            else if (info.status === 'error') statusEl.classList.add('warning');
                            else statusEl.classList.add('critical');
                        }

                        // ElevenLabs has real remaining/limit
                        if (info.remaining !== undefined && info.limit !== undefined) {
                            const pct = info.limit > 0 ? Math.round((info.remaining / info.limit) * 100) : 0;
                            if (fillEl) fillEl.style.width = pct + '%';
                            if (balEl) balEl.textContent = `${info.remaining.toLocaleString()} / ${info.limit.toLocaleString()} chars`;
                        } else {
                            // Status-only providers
                            if (fillEl) fillEl.style.width = info.status === 'active' ? '100%' : (info.status === 'error' ? '30%' : '0%');
                            if (balEl) {
                                if (info.status === 'active') balEl.textContent = `‚úÖ Active ‚Äî ${info.note || info.provider}`;
                                else if (info.status === 'missing') balEl.textContent = '‚ùå Key not configured';
                                else balEl.textContent = `‚ö†Ô∏è Error: ${info.error || info.note || 'Check config'}`;
                            }
                        }
                    });

                    // Summary badge
                    if (data.summary) {
                        console.log(`ü§ñ AI Status: ${data.summary.active}/${data.summary.total_providers} active`);
                    }
                }
            } catch (error) {
                console.error('Failed to load credits:', error);
            }
        }

        function updateStatusIndicator(elementId, status) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = 'credit-status';
            if (status === 'critical' || status === 'missing') el.classList.add('critical');
            else if (status === 'warning' || status === 'error') el.classList.add('warning');
            else el.classList.add('ok');
        }

        async function updateCredit(service) {
            const usedInput = document.getElementById(`${service}-used`);
            const limitInput = document.getElementById(`${service}-limit`);

            if (!usedInput || !limitInput) {
                alert('C√¢mpuri lipsƒÉ pentru ' + service);
                return;
            }

            const used = parseFloat(usedInput.value) || 0;
            const limit = parseFloat(limitInput.value) || 100;
            const remaining = limit - used;

            try {
                const response = await fetch('/.netlify/functions/ai-credits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update',
                        service: service,
                        used: used,
                        limit: limit,
                        remaining: remaining
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Credit ' + service + ' salvat!');
                    loadCredits(); // Refresh
                    usedInput.value = '';
                    limitInput.value = '';
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown'));
                }
            } catch (error) {
                console.error('Update credit error:', error);
                alert('‚ùå Save error: ' + error.message);
            }
        }

        async function testAllAPIs() {
            await loadAPIStatus();
            alert('API tests completed! Check the status cards above.');
        }

        function exportLogs() {
            alert('Log export feature coming soon!');
        }

        // ============ ADMIN TRAFFIC & MESSAGING ============
        const JSONBIN_MASTER_KEY = '$2a$10$Bqkm3LW5Z73QHiBMoQy3EemzmGhd8hvQLBk0vm7Gol3sqIFUGqHv6';
        const JSONBIN_API = 'https://api.jsonbin.io/v3/b';
        let trafficData = [];
        let selectedUserId = null;

        // Modal functions
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Traffic Modal - uses live Supabase data
        async function openTrafficModal() {
            openModal('traffic-modal');
            document.getElementById('traffic-loading').style.display = 'block';
            document.getElementById('traffic-table').style.display = 'none';

            try {
                // Fetch live traffic from Supabase via admin-traffic API
                const response = await fetch('/.netlify/functions/admin-traffic?minutes=43200&limit=200');

                if (!response.ok) throw new Error('Failed to fetch traffic data');

                const data = await response.json();

                if (data.success) {
                    trafficData = data.visitors || [];

                    // Update new stats section
                    if (data.stats) {
                        document.getElementById('traffic-stats').style.display = 'block';
                        document.getElementById('stat-total-views').textContent = data.stats.totalViews || 0;
                        document.getElementById('stat-unique').textContent = data.stats.uniqueVisitors || 0;
                        document.getElementById('stat-period').textContent = data.stats.period || 'Last 24h';

                        // Format countries
                        const countries = data.stats.byCountry || {};
                        const countryList = Object.entries(countries)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 5)
                            .map(([country, count]) => `${country}: ${count}`)
                            .join(' ‚Ä¢ ');
                        document.getElementById('stat-countries').textContent = countryList || 'No data';

                        // Format devices
                        const devices = data.stats.byDevice || {};
                        const deviceList = Object.entries(devices)
                            .sort((a, b) => b[1] - a[1])
                            .map(([device, count]) => {
                                const icon = device === 'Mobile' ? 'üì±' : device === 'Desktop' ? 'üíª' : 'üì±';
                                return `${icon} ${device}: ${count}`;
                            })
                            .join(' ‚Ä¢ ');
                        document.getElementById('stat-devices').textContent = deviceList || 'No data';
                    }

                    document.getElementById('traffic-loading').style.display = 'none';
                    renderTrafficTable();
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Traffic fetch error:', error);
                document.getElementById('traffic-loading').innerHTML =
                    '<span style="color: #ff6b6b;">Failed to load traffic: ' + error.message + '</span>';
            }
        }

        function renderTrafficTable() {
            document.getElementById('traffic-table').style.display = 'table';

            const tbody = document.getElementById('traffic-body');
            tbody.innerHTML = trafficData.map(entry => {
                // Format location with country flag
                const geo = entry.geo || {};
                const countryCode = geo.countryCode || 'XX';
                const flagEmoji = countryCode !== 'XX' ? String.fromCodePoint(...[...countryCode.toUpperCase()].map(c => 0x1F1E6 - 65 + c.charCodeAt(0))) : 'üåç';
                const locationStr = [geo.city, geo.country].filter(Boolean).join(', ') || 'Unknown';
                const ispStr = geo.isp || geo.asn || 'Unknown ISP';

                // Format device info
                const device = entry.device || {};
                const deviceIcon = device.device === 'Mobile' ? 'üì±' : device.device === 'Tablet' ? 'üì±' : 'üíª';
                const deviceStr = `${device.browser || 'Unknown'} / ${device.os || 'Unknown'}`;

                // Format duration
                let timeSpent = 'N/A';
                if (entry.duration_ms) {
                    const secs = Math.floor(entry.duration_ms / 1000);
                    const mins = Math.floor(secs / 60);
                    timeSpent = mins > 0 ? `${mins}m ${secs % 60}s` : `${secs}s`;
                }

                // Format timestamp
                const time = entry.timestamp ? new Date(entry.timestamp).toLocaleString('ro-RO') : 'N/A';

                return `
                <tr data-id="${entry.id}" style="border-bottom: 2px solid rgba(212,175,55,0.3);">
                    <td colspan="4" style="padding: 12px 20px;">
                        <!-- ROW 1: Time, IP, Country -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.9em; font-weight: bold; color: #00ffff;">${time}</div>
                                <div style="font-size: 0.75em; color: rgba(255,255,255,0.4);">üìÑ ${entry.page || '/'}</div>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <code style="background: rgba(0,0,0,0.5); padding: 4px 12px; border-radius: 6px; font-size: 0.85em; color: #d4af37;">${entry.ip || 'Unknown IP'}</code>
                            </div>
                            <div style="flex: 1; text-align: right;">
                                <div style="font-size: 0.9em;">${flagEmoji} ${locationStr}</div>
                            </div>
                        </div>
                        
                        <!-- ROW 2: ISP, Device, Browser/OS, Duration -->
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; color: rgba(255,255,255,0.6);">
                            <div style="flex: 1;">
                                <span style="color: rgba(0,255,100,0.8);">üåê ${ispStr}</span>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <span>${deviceIcon} ${device.device || 'Desktop'}</span>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <span>üñ•Ô∏è ${deviceStr}</span>
                            </div>
                            <div style="flex: 1; text-align: right;">
                                <span style="color: rgba(212,175,55,0.8);">‚è±Ô∏è ${timeSpent}</span>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            // Also populate user list for MSG modal
            populateUserList();
        }

        function populateUserList() {
            const userList = document.getElementById('user-list');
            if (trafficData.length === 0) {
                userList.innerHTML = '<div style="color: rgba(255,255,255,0.5);">No users found. Open Traffic first.</div>';
                return;
            }

            userList.innerHTML = trafficData.map(entry => {
                const geo = entry.geo || {};
                const countryCode = geo.countryCode || 'XX';
                const flagEmoji = countryCode !== 'XX' ? String.fromCodePoint(...[...countryCode.toUpperCase()].map(c => 0x1F1E6 - 65 + c.charCodeAt(0))) : 'üåç';
                const locationStr = [geo.city, geo.country].filter(Boolean).join(', ') || 'Unknown';

                return `
                <div class="user-item" onclick="selectUser('${entry.id}')" data-id="${entry.id}">
                    <span>${flagEmoji}</span>
                    <span style="font-family: monospace;">${entry.ip || 'Unknown IP'}</span>
                    <span style="color: rgba(255,255,255,0.5);">‚Ä¢ ${locationStr}</span>
                </div>
            `;
            }).join('');
        }

        function selectUser(userId) {
            selectedUserId = userId;
            document.querySelectorAll('.user-item').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.id === userId) {
                    el.classList.add('selected');
                }
            });
        }

        // MSG Modal
        function openMsgModal() {
            populateUserList();
            openModal('msg-modal');
        }

        // MSG All Modal
        function openMsgAllModal() {
            openModal('msg-all-modal');
        }

        // Send single message
        async function sendMessage() {
            const content = document.getElementById('msg-content').value.trim();

            if (!selectedUserId) {
                alert('Please select a user first');
                return;
            }

            if (!content) {
                alert('Please enter a message');
                return;
            }

            // Store message in localStorage (for demo - would use Supabase in production)
            const messages = JSON.parse(localStorage.getItem('admin_messages') || '[]');
            messages.push({
                id: Date.now(),
                type: 'single',
                recipientId: selectedUserId,
                content: content,
                createdAt: new Date().toISOString(),
                isRead: false
            });
            localStorage.setItem('admin_messages', JSON.stringify(messages));

            alert('Message sent to user!');
            document.getElementById('msg-content').value = '';
            closeModal('msg-modal');
        }

        // Send broadcast message
        async function sendBroadcast() {
            const content = document.getElementById('msg-all-content').value.trim();

            if (!content) {
                alert('Please enter a message');
                return;
            }

            // Store broadcast message in localStorage
            const messages = JSON.parse(localStorage.getItem('admin_messages') || '[]');
            messages.push({
                id: Date.now(),
                type: 'broadcast',
                recipientId: null,
                content: content,
                createdAt: new Date().toISOString(),
                isRead: false
            });
            localStorage.setItem('admin_messages', JSON.stringify(messages));

            alert('Broadcast message sent to all users!');
            document.getElementById('msg-all-content').value = '';
            closeModal('msg-all-modal');
        }

        // ============ CLIENTS DATABASE ============
        let clientsData = [];

        async function openClientsModal() {
            openModal('clients-modal');
            document.getElementById('clients-loading').style.display = 'block';
            document.getElementById('clients-table').style.display = 'none';
            document.getElementById('clients-stats').style.display = 'none';

            try {
                // Fetch clients from admin endpoint
                const token = localStorage.getItem('kelion_auth_token');
                const response = await fetch('/.netlify/functions/auth-me?list=all', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (!response.ok) {
                    throw new Error('Could not load clients: ' + response.status);
                }

                const data = await response.json();

                // Handle both array and single user response
                if (Array.isArray(data.users)) {
                    clientsData = data.users;
                } else if (data.user) {
                    // If only single user returned, show just that
                    clientsData = [data.user];
                } else {
                    clientsData = [];
                }

                renderClientsTable();
            } catch (error) {
                console.error('Clients fetch error:', error);
                document.getElementById('clients-loading').innerHTML =
                    '<span style="color: #ff6b6b;">Error: ' + error.message + '</span>' +
                    '<br><small style="color: #888;">Client listing function requires special endpoint. Data will be available soon.</small>';
            }
        }

        function renderClientsTable() {
            document.getElementById('clients-loading').style.display = 'none';
            document.getElementById('clients-table').style.display = 'table';
            document.getElementById('clients-stats').style.display = 'block';

            // Calculate stats
            const total = clientsData.length;
            const premium = clientsData.filter(c => c.subscription_status === 'active' || c.subscription_status === 'premium').length;
            const admins = clientsData.filter(c => c.role === 'admin' || c.role === 'superadmin').length;

            document.getElementById('clients-total').textContent = total;
            document.getElementById('clients-premium').textContent = premium;
            document.getElementById('clients-admin').textContent = admins;

            const tbody = document.getElementById('clients-body');
            tbody.innerHTML = clientsData.map(client => `
                <tr>
                    <td>${client.email || 'N/A'}</td>
                    <td>
                        <span style="background: ${client.role === 'admin' ? 'rgba(255,100,100,0.3)' : 'rgba(100,255,100,0.3)'}; 
                              padding: 3px 10px; border-radius: 10px;">
                            ${client.role || 'user'}
                        </span>
                    </td>
                    <td>
                        <span style="background: ${client.subscription_status === 'active' ? 'rgba(212,175,55,0.3)' : 'rgba(100,100,100,0.3)'}; 
                              padding: 3px 10px; border-radius: 10px;">
                            ${client.subscription_status || 'free'}
                        </span>
                    </td>
                    <td>${client.created_at ? new Date(client.created_at).toLocaleDateString('ro-RO') : 'N/A'}</td>
                    <td>
                        <button onclick="viewClient('${client.id}')" style="background: rgba(0,191,255,0.2); border: 1px solid #00bfff; color: #00bfff; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px;">
                            üëÅÔ∏è
                        </button>
                        <button onclick="msgClient('${client.email}')" style="background: rgba(168,85,247,0.2); border: 1px solid #a855f7; color: #a855f7; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            üí¨
                        </button>
                    </td>
                </tr>
            `).join('');

            if (clientsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">No clients found</td></tr>';
            }
        }

        function viewClient(clientId) {
            alert('Detalii client: ' + clientId + '\n\nFunc»õionalitate √Æn dezvoltare.');
        }

        function msgClient(email) {
            closeModal('clients-modal');
            openMsgModal();
            // Pre-select this user if available
            setTimeout(() => {
                const content = document.getElementById('msg-content');
                if (content) content.placeholder = 'Mesaj pentru ' + email + '...';
            }, 100);
        }

        // ============ MODAL FUNCTIONS ============
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // NOTE: openTrafficModal is defined above at line ~1696, using admin-traffic API with geo data
        // Do NOT re-define it here

        // MSG MODAL - Send to single user
        function openMsgModal() {
            const modal = document.getElementById('msg-modal');
            modal.classList.add('active');

            // Load users from clients data
            const userList = document.getElementById('user-list');
            if (clientsData && clientsData.length > 0) {
                userList.innerHTML = clientsData.map(client => `
                    <div class="user-item" onclick="selectUser(this, '${client.email}')">
                        <span style="font-size: 1.2rem;">üë§</span>
                        <span>${client.email}</span>
                        <span style="color: #888; font-size: 0.8rem;">${client.role || 'user'}</span>
                    </div>
                `).join('');
            } else {
                userList.innerHTML = '<div style="color:#888;padding:10px;">No users loaded. Open Clients panel first.</div>';
            }
        }

        let selectedUserEmail = null;
        function selectUser(el, email) {
            document.querySelectorAll('.user-item').forEach(item => item.classList.remove('selected'));
            el.classList.add('selected');
            selectedUserEmail = email;
        }

        async function sendMessage() {
            const content = document.getElementById('msg-content').value.trim();
            if (!content) {
                alert('Te rog scrie un mesaj!');
                return;
            }
            if (!selectedUserEmail) {
                alert('Te rog selecteazƒÉ un utilizator!');
                return;
            }

            alert('üì§ Mesaj trimis cƒÉtre ' + selectedUserEmail + ':\n\n' + content);
            closeModal('msg-modal');
            document.getElementById('msg-content').value = '';
            selectedUserEmail = null;
        }

        // MSG ALL MODAL - Broadcast
        function openMsgAllModal() {
            document.getElementById('msg-all-modal').classList.add('active');
        }

        async function sendBroadcast() {
            const content = document.getElementById('msg-all-content').value.trim();
            if (!content) {
                alert('Te rog scrie un mesaj pentru broadcast!');
                return;
            }

            alert('üì¢ Broadcast trimis cƒÉtre to»õi utilizatorii:\n\n' + content);
            closeModal('msg-all-modal');
            document.getElementById('msg-all-content').value = '';
        }
    </script>

    <!-- Live Financial Dashboard + Notifications -->
    <style>
        .fin-dash {
            margin: 20px;
            padding: 20px;
            background: rgba(167, 139, 250, 0.05);
            border: 1px solid rgba(167, 139, 250, 0.15);
            border-radius: 16px;
            max-width: 800px;
        }

        .fin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .fin-title {
            color: #a78bfa;
            font-size: 1.1rem;
            margin: 0;
        }

        .fin-links {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .fin-links a {
            color: #a78bfa;
            font-size: .7rem;
            text-decoration: none;
            padding: 4px 12px;
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 8px;
        }

        .fin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 14px;
        }

        .fin-card {
            text-align: center;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .fin-val {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .fin-label {
            font-size: .55rem;
            color: rgba(255, 255, 255, 0.3);
            margin-top: 3px;
        }

        .notif-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .notif-badge {
            position: absolute;
            top: -6px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: .5rem;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 14px;
            text-align: center;
        }

        .notif-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(167, 139, 250, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: .8rem;
            z-index: 99999;
            opacity: 0;
            transition: opacity .3s;
            max-width: 350px;
        }

        .notif-toast.show {
            opacity: 1;
        }

        .notif-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: .7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .notif-item {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .notif-item .type {
            color: #a78bfa;
            font-weight: 600;
        }

        .notif-item .time {
            color: rgba(255, 255, 255, 0.2);
            font-size: .6rem;
        }
    </style>

    <div class="fin-dash" id="fin-dash">
        <div class="fin-header">
            <h3 class="fin-title">üí∞ Financial Dashboard <span style="font-size:.6rem;color:rgba(255,255,255,0.3)"
                    id="fin-refresh">live</span></h3>
            <div class="fin-links">
                <span class="notif-bell" id="notif-bell" onclick="toggleNotifs()">üîî <span class="notif-badge"
                        id="notif-badge" style="display:none">0</span></span>
                <a href="/developers.html" target="_blank">Dev Portal ‚Üí</a>
            </div>
        </div>
        <div class="fin-grid" id="fin-grid">
            <div class="fin-card">
                <div class="fin-val" style="color:#ef4444" id="f-cost-today">‚Äî</div>
                <div class="fin-label">Cost Today ($)</div>
            </div>
            <div class="fin-card">
                <div class="fin-val" style="color:#f97316" id="f-cost-month">‚Äî</div>
                <div class="fin-label">Cost This Month ($)</div>
            </div>
            <div class="fin-card">
                <div class="fin-val" style="color:#4ade80" id="f-revenue">‚Äî</div>
                <div class="fin-label">Revenue Month ($)</div>
            </div>
            <div class="fin-card">
                <div class="fin-val" style="color:#22d3ee" id="f-profit">‚Äî</div>
                <div class="fin-label">Profit Month ($)</div>
            </div>
            <div class="fin-card">
                <div class="fin-val" style="color:#a78bfa" id="f-keys">‚Äî</div>
                <div class="fin-label">Active API Keys</div>
            </div>
            <div class="fin-card">
                <div class="fin-val" style="color:#fbbf24" id="f-credits">‚Äî</div>
                <div class="fin-label">Credits Outstanding</div>
            </div>
        </div>
        <div style="font-size:.55rem;color:rgba(255,255,255,0.15);margin-bottom:10px">Pricing: Starter $5 (1K) ¬∑
            Developer $40 (10K) ¬∑ Business $300 (100K) ¬∑ All via PayPal</div>
        <div id="notif-panel" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <span style="color:#a78bfa;font-size:.75rem;font-weight:600">üìã Recent Alerts</span>
                <span style="color:rgba(255,255,255,0.3);font-size:.6rem;cursor:pointer" onclick="markAllRead()">Mark
                    all read</span>
            </div>
            <div class="notif-list" id="notif-list">Loading...</div>
        </div>
    </div>
    <div class="notif-toast" id="notif-toast"></div>

    <script>
        // ‚ïê‚ïê‚ïê LIVE FINANCIAL DASHBOARD ‚ïê‚ïê‚ïê
        let lastNotifCount = 0;

        async function loadFinancials() {
            try {
                const res = await fetch('/.netlify/functions/admin-notify', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'financial_summary' })
                });
                const d = await res.json();
                if (d.success) {
                    document.getElementById('f-cost-today').textContent = '$' + (d.costs?.today || 0).toFixed(4);
                    document.getElementById('f-cost-month').textContent = '$' + (d.costs?.month || 0).toFixed(2);
                    document.getElementById('f-revenue').textContent = '$' + (d.revenue?.month || 0).toFixed(2);
                    document.getElementById('f-profit').textContent = '$' + (d.profit?.month || 0).toFixed(2);
                    document.getElementById('f-keys').textContent = d.api_keys?.active || 0;
                    document.getElementById('f-credits').textContent = (d.api_keys?.credits_remaining || 0).toLocaleString();
                    document.getElementById('fin-refresh').textContent = 'updated ' + new Date().toLocaleTimeString();
                }
            } catch (e) { console.log('Financials fetch error:', e); }
        }

        async function loadNotifications() {
            try {
                const res = await fetch('/.netlify/functions/admin-notify', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_notifications' })
                });
                const d = await res.json();
                if (d.success) {
                    const badge = document.getElementById('notif-badge');
                    if (d.unread > 0) {
                        badge.textContent = d.unread;
                        badge.style.display = '';
                        // Show toast for new notifications
                        if (d.unread > lastNotifCount && lastNotifCount >= 0) {
                            const latest = d.notifications[0];
                            showToast(`${eventIcon(latest.event_type)} ${latest.event_type}: ${JSON.stringify(latest.data).substring(0, 80)}`);
                        }
                        lastNotifCount = d.unread;
                    } else {
                        badge.style.display = 'none';
                    }
                    // Render list
                    const list = document.getElementById('notif-list');
                    list.innerHTML = (d.notifications || []).slice(0, 20).map(n => `
                    <div class="notif-item" style="${n.read ? '' : 'background:rgba(167,139,250,0.05)'}">
                        <span class="type">${eventIcon(n.event_type)} ${n.event_type}</span>
                        <span class="time">${new Date(n.created_at).toLocaleString()}</span>
                        <div style="color:rgba(255,255,255,0.4);font-size:.6rem">${JSON.stringify(n.data).substring(0, 120)}</div>
                    </div>
                `).join('') || '<div style="padding:10px;text-align:center">No notifications yet</div>';
                }
            } catch (e) { console.log('Notif fetch error:', e); }
        }

        function eventIcon(type) {
            const icons = { new_api_key: 'üîë', payment_received: 'üí≥', low_credits: '‚ö†Ô∏è', high_usage: 'üìà', daily_report: 'üìä' };
            return icons[type] || 'üìå';
        }

        function showToast(msg) {
            const t = document.getElementById('notif-toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 5000);
        }

        function toggleNotifs() {
            const p = document.getElementById('notif-panel');
            p.style.display = p.style.display === 'none' ? 'block' : 'none';
        }

        async function markAllRead() {
            await fetch('/.netlify/functions/admin-notify', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'mark_read' })
            });
            lastNotifCount = 0;
            loadNotifications();
        }

        // Auto-refresh every 30s
        loadFinancials();
        loadNotifications();
        setInterval(loadFinancials, 30000);
        setInterval(loadNotifications, 15000);
    </script>
</body>

</html>